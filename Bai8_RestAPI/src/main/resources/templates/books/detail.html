<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/layout :: head"></head>
<body>
    <nav th:replace="fragments/layout :: navbar"></nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-circle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/books">Sản phẩm</a></li>
                <li class="breadcrumb-item active" th:text="${book.title}">Book</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Product Image -->
            <div class="col-lg-5 mb-4">
                <div class="position-relative">
                    <img th:src="${book.imageUrl ?: 'https://picsum.photos/seed/' + book.id + '/400/500'}" 
                         class="img-fluid rounded shadow-lg" th:alt="${book.title}" style="width: 100%;">
                    <span th:if="${book.stock <= 0}" class="position-absolute top-0 start-0 m-3 badge bg-danger fs-6">
                        Hết hàng
                    </span>
                </div>
                
                <!-- Quick Actions -->
                <div class="d-flex gap-2 mt-3">
                    <form sec:authorize="isAuthenticated()" th:action="@{/favorites/add/{id}(id=${book.id})}" method="post" class="flex-grow-1">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-heart"></i> Yêu thích
                        </button>
                    </form>
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <span th:if="${book.category}" class="category-badge mb-2 d-inline-block" 
                              th:text="${book.category.name}">Category</span>
                        
                        <h1 class="display-6 fw-bold mb-2" th:text="${book.title}">Book Title</h1>
                        
                        <!-- Rating Summary -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="text-warning fs-5">
                                    <i th:each="i : ${#numbers.sequence(1, 5)}" 
                                       th:class="${i <= avgRating} ? 'bi bi-star-fill' : 'bi bi-star'"
                                       class="bi bi-star"></i>
                                </div>
                                <span class="fw-bold" th:text="${avgRating} + '/5'">0/5</span>
                                <span class="text-muted">(<span th:text="${reviewCount}">0</span> đánh giá)</span>
                            </div>
                        </div>
                        
                        <p class="text-muted fs-5">Tác giả: <strong th:text="${book.author}">Author</strong></p>
                        
                        <div class="my-4 p-3 bg-light rounded">
                            <span class="fs-2 text-danger fw-bold" 
                                  th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</span>
                            <span class="text-muted ms-3" th:if="${book.stock > 0}">
                                <i class="bi bi-check-circle-fill text-success"></i> 
                                Còn <span th:text="${book.stock}">0</span> sản phẩm
                            </span>
                            <span class="text-muted ms-3" th:if="${book.stock <= 0}">
                                <i class="bi bi-x-circle-fill text-danger"></i> Hết hàng
                            </span>
                        </div>

                        <div class="mb-4">
                            <h5><i class="bi bi-info-circle"></i> Mô tả sản phẩm</h5>
                            <p class="text-secondary" th:text="${book.description} ?: 'Chưa có mô tả cho sản phẩm này.'">Description</p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 flex-wrap">
                            <form sec:authorize="hasRole('USER')" th:action="@{/cart/add/{id}(id=${book.id})}" method="post">
                                <button type="submit" class="btn btn-primary btn-lg" th:disabled="${book.stock <= 0}">
                                    <i class="bi bi-cart-plus"></i> 
                                    <span th:text="${book.stock > 0} ? 'Thêm vào giỏ' : 'Hết hàng'">Thêm vào giỏ</span>
                                </button>
                            </form>
                            <a sec:authorize="!isAuthenticated()" href="/login" class="btn btn-secondary btn-lg">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để mua
                            </a>
                            <div sec:authorize="hasRole('ADMIN')" class="alert alert-warning py-2 px-3 mb-0">
                                <i class="bi bi-info-circle"></i> Admin không thể mua
                            </div>
                            <a href="/books" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left"></i> Quay lại
                            </a>
                        </div>

                        <!-- Admin actions -->
                        <div sec:authorize="hasRole('ADMIN')" class="mt-4 pt-4 border-top">
                            <h6 class="text-muted"><i class="bi bi-gear"></i> Quản trị</h6>
                            <div class="btn-group">
                                <a th:href="@{/books/edit/{id}(id=${book.id})}" class="btn btn-warning">
                                    <i class="bi bi-pencil"></i> Chỉnh sửa
                                </a>
                                <a th:href="@{/books/delete/{id}(id=${book.id})}" class="btn btn-danger"
                                   onclick="return confirm('Xác nhận xóa sản phẩm này?')">
                                    <i class="bi bi-trash"></i> Xóa
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 pt-4">
                        <h3><i class="bi bi-chat-dots"></i> Đánh giá & Bình luận</h3>
                    </div>
                    <div class="card-body">
                        <!-- Rating Summary -->
                        <div class="row mb-4">
                            <div class="col-md-4 text-center border-end">
                                <div class="display-4 fw-bold text-warning" th:text="${avgRating}">0</div>
                                <div class="text-warning fs-4">
                                    <i th:each="i : ${#numbers.sequence(1, 5)}" 
                                       th:class="${i <= avgRating} ? 'bi bi-star-fill' : 'bi bi-star'"
                                       class="bi bi-star"></i>
                                </div>
                                <p class="text-muted mt-2"><span th:text="${reviewCount}">0</span> đánh giá</p>
                            </div>
                            <div class="col-md-8">
                                <!-- Review Form -->
                                <div sec:authorize="hasRole('USER')" class="mb-4">
                                    <div th:if="${userReview != null}">
                                        <div class="alert alert-info">
                                            <strong>Bạn đã đánh giá sản phẩm này!</strong>
                                            <div class="mt-2">
                                                <span th:if="${userReview.approved}" class="badge bg-success">Đã duyệt</span>
                                                <span th:unless="${userReview.approved}" class="badge bg-warning">Chờ duyệt</span>
                                            </div>
                                        </div>
                                        <!-- Edit Review Form -->
                                        <form th:action="@{/reviews/update/{id}(id=${userReview.id})}" method="post" class="mt-3">
                                            <input type="hidden" name="bookId" th:value="${book.id}">
                                            <div class="mb-3">
                                                <label class="form-label">Cập nhật đánh giá của bạn:</label>
                                                <div class="btn-group" role="group">
                                                    <input type="radio" class="btn-check" name="rating" id="star1" value="1" th:checked="${userReview.rating == 1}">
                                                    <label class="btn btn-outline-warning" for="star1"><i class="bi bi-star"></i></label>
                                                    
                                                    <input type="radio" class="btn-check" name="rating" id="star2" value="2" th:checked="${userReview.rating == 2}">
                                                    <label class="btn btn-outline-warning" for="star2"><i class="bi bi-star"></i></label>
                                                    
                                                    <input type="radio" class="btn-check" name="rating" id="star3" value="3" th:checked="${userReview.rating == 3}">
                                                    <label class="btn btn-outline-warning" for="star3"><i class="bi bi-star"></i></label>
                                                    
                                                    <input type="radio" class="btn-check" name="rating" id="star4" value="4" th:checked="${userReview.rating == 4}">
                                                    <label class="btn btn-outline-warning" for="star4"><i class="bi bi-star"></i></label>
                                                    
                                                    <input type="radio" class="btn-check" name="rating" id="star5" value="5" th:checked="${userReview.rating == 5}">
                                                    <label class="btn btn-outline-warning" for="star5"><i class="bi bi-star"></i></label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <textarea name="comment" class="form-control" rows="3" placeholder="Viết bình luận của bạn..." 
                                                          th:text="${userReview.comment}" required></textarea>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-pencil"></i> Cập nhật đánh giá
                                                </button>
                                                <a th:href="@{/reviews/delete/{id}(id=${userReview.id}, bookId=${book.id})}" 
                                                   class="btn btn-outline-danger"
                                                   onclick="return confirm('Xóa đánh giá của bạn?')">
                                                    <i class="bi bi-trash"></i> Xóa
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <form th:unless="${userReview != null}" th:action="@{/reviews/add/{id}(id=${book.id})}" method="post">
                                        <div class="mb-3">
                                            <label class="form-label">Đánh giá của bạn:</label>
                                            <div class="btn-group" role="group">
                                                <input type="radio" class="btn-check" name="rating" id="star1" value="1" required>
                                                <label class="btn btn-outline-warning" for="star1"><i class="bi bi-star"></i></label>
                                                
                                                <input type="radio" class="btn-check" name="rating" id="star2" value="2">
                                                <label class="btn btn-outline-warning" for="star2"><i class="bi bi-star"></i></label>
                                                
                                                <input type="radio" class="btn-check" name="rating" id="star3" value="3">
                                                <label class="btn btn-outline-warning" for="star3"><i class="bi bi-star"></i></label>
                                                
                                                <input type="radio" class="btn-check" name="rating" id="star4" value="4">
                                                <label class="btn btn-outline-warning" for="star4"><i class="bi bi-star"></i></label>
                                                
                                                <input type="radio" class="btn-check" name="rating" id="star5" value="5">
                                                <label class="btn btn-outline-warning" for="star5"><i class="bi bi-star"></i></label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <textarea name="comment" class="form-control" rows="3" placeholder="Viết bình luận của bạn..." required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i> Gửi đánh giá
                                        </button>
                                    </form>
                                </div>
                                
                                <div sec:authorize="!isAuthenticated()" class="alert alert-light border text-center">
                                    <p class="mb-2">Vui lòng <a href="/login">đăng nhập</a> để đánh giá sản phẩm</p>
                                </div>
                                
                                <div sec:authorize="hasRole('ADMIN')" class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Admin không thể đánh giá sản phẩm
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Reviews List -->
                        <h5 class="mb-3">Bình luận (<span th:text="${#lists.size(reviews)}">0</span>)</h5>
                        
                        <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-4 text-muted">
                            <i class="bi bi-chat-square-dots display-4 d-block mb-2"></i>
                            <p>Chưa có bình luận nào. Hãy là ngườ đầu tiên đánh giá!</p>
                        </div>

                        <div th:unless="${#lists.isEmpty(reviews)}" class="review-list">
                            <div th:each="review : ${reviews}" class="review-item mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px;">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold" th:text="${review.user.fullName} ?: ${review.user.username}">User</div>
                                                <small class="text-muted" th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy')}">Date</small>
                                            </div>
                                        </div>
                                        <div class="text-warning mb-2">
                                            <i th:each="i : ${#numbers.sequence(1, review.rating)}" class="bi bi-star-fill"></i>
                                            <i th:each="i : ${#numbers.sequence(review.rating + 1, 5)}" class="bi bi-star"></i>
                                        </div>
                                        <p class="mb-0" th:text="${review.comment}">Comment</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products / You May Also Like -->
        <div th:if="${!#lists.isEmpty(relatedProducts)}" class="row mt-5">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 pt-4">
                        <h3><i class="bi bi-magic text-primary"></i> Có thể bạn cũng thích</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div th:each="relatedBook : ${relatedProducts}" class="col-6 col-md-4 col-lg-2">
                                <div class="card book-card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                    <img th:src="${relatedBook.imageUrl ?: 'https://picsum.photos/seed/' + relatedBook.id + '/300/400'}" 
                                         class="card-img-top" th:alt="${relatedBook.title}" style="height: 180px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <h6 class="card-title small fw-bold text-truncate" th:text="${relatedBook.title}" th:title="${relatedBook.title}">Title</h6>
                                        <p class="text-muted small mb-1" th:text="${relatedBook.author}">Author</p>
                                        <p class="price-tag mb-0 small" th:text="${#numbers.formatDecimal(relatedBook.price, 0, 'COMMA', 0, 'POINT')} + ' VND'">0</p>
                                    </div>
                                    <div class="card-footer bg-white border-0 pb-2 pt-0">
                                        <a th:href="@{/books/detail/{id}(id=${relatedBook.id})}" class="btn btn-outline-primary btn-sm w-100">
                                            <i class="bi bi-eye"></i> Xem
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="fragments/layout :: footer"></footer>
    <div th:replace="fragments/layout :: scripts"></div>
</body>
</html>
