<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="admin/layout :: head"></head>
<body>
    <nav th:replace="admin/layout :: sidebar"></nav>

    <main class="admin-content">
        <div class="admin-header">
            <div>
                <h4 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Thống kê doanh thu</h4>
            </div>
            <select id="yearSelect" class="form-select" style="width: 120px;" onchange="changeYear()">
                <option th:value="${currentYear}" th:text="${currentYear}" selected>Năm</option>
                <option th:value="${currentYear - 1}" th:text="${currentYear - 1}"></option>
                <option th:value="${currentYear - 2}" th:text="${currentYear - 2}"></option>
            </select>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-2">Tổng doanh thu</h6>
                                <h3 class="mb-0 fw-bold" th:text="${#numbers.formatDecimal(stats.totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' VND'">0</h3>
                            </div>
                            <div class="bg-white bg-opacity-25 rounded-circle p-3">
                                <i class="bi bi-currency-dollar fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="card-body text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-2">Tổng đơn hàng</h6>
                                <h3 class="mb-0 fw-bold" th:text="${stats.totalOrders}">0</h3>
                            </div>
                            <div class="bg-white bg-opacity-25 rounded-circle p-3">
                                <i class="bi bi-bag fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card stat-card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="card-body text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 mb-2">Giá trị đơn trung bình</h6>
                                <h3 class="mb-0 fw-bold" th:text="${#numbers.formatDecimal(stats.averageOrderValue, 0, 'COMMA', 0, 'POINT')} + ' VND'">0</h3>
                            </div>
                            <div class="bg-white bg-opacity-25 rounded-circle p-3">
                                <i class="bi bi-calculator fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Monthly Revenue Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Doanh thu theo tháng</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Daily Revenue Chart -->
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-calendar-week"></i> 7 ngày gần nhất</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Top Selling Products -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> Top 10 sản phẩm bán chạy</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>STT</th>
                                        <th>Sản phẩm</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end">Doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="product, iterStat : ${topProducts}">
                                        <td>
                                            <span class="badge" th:classappend="${iterStat.index < 3} ? 'bg-warning' : 'bg-secondary'" 
                                                  th:text="${iterStat.index + 1}">1</span>
                                        </td>
                                        <td th:text="${product.bookTitle}" class="text-truncate" style="max-width: 200px;">Title</td>
                                        <td class="text-center fw-bold" th:text="${product.quantitySold}">0</td>
                                        <td class="text-end" th:text="${#numbers.formatDecimal(product.revenue, 0, 'COMMA', 0, 'POINT')}">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Chi tiết theo tháng</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover mb-0">
                                <thead class="bg-light sticky-top">
                                    <tr>
                                        <th>Tháng</th>
                                        <th class="text-center">Đơn hàng</th>
                                        <th class="text-end">Doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="month : ${monthlyRevenue}" th:if="${month.revenue > 0}">
                                        <td th:text="${month.month}">Month</td>
                                        <td class="text-center" th:text="${month.orderCount}">0</td>
                                        <td class="text-end fw-bold text-primary" 
                                            th:text="${#numbers.formatDecimal(month.revenue, 0, 'COMMA', 0, 'POINT')}">0</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(monthlyRevenue.?[revenue > 0])}">
                                        <td colspan="3" class="text-center text-muted py-4">Chưa có dữ liệu</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="admin/layout :: scripts"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        // Monthly Revenue Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        const monthlyData = /*[[${monthlyRevenue}]]*/ [];
        
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: monthlyData.map(item => item.month),
                datasets: [{
                    label: 'Doanh thu (VND)',
                    data: monthlyData.map(item => item.revenue),
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }, {
                    label: 'Số đơn hàng',
                    data: monthlyData.map(item => item.orderCount),
                    type: 'line',
                    borderColor: 'rgba(245, 87, 108, 1)',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + ' đ';
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.dataset.type === 'line') {
                                    label += context.parsed.y + ' đơn';
                                } else {
                                    label += context.parsed.y.toLocaleString('vi-VN') + ' VND';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Daily Revenue Chart
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        const dailyData = /*[[${dailyRevenue}]]*/ [];
        
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: dailyData.map(item => {
                    const date = new Date(item.date);
                    return date.getDate() + '/' + (date.getMonth() + 1);
                }),
                datasets: [{
                    label: 'Doanh thu',
                    data: dailyData.map(item => item.revenue),
                    borderColor: 'rgba(79, 172, 254, 1)',
                    backgroundColor: 'rgba(79, 172, 254, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return (value / 1000000).toFixed(1) + 'M';
                            }
                        }
                    }
                }
            }
        });

        function changeYear() {
            const year = document.getElementById('yearSelect').value;
            window.location.href = '/admin/revenue?year=' + year;
        }
    </script>
</body>
</html>
